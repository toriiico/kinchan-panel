<!DOCTYPE html>
<html>
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-122581403-2"></script>
    <script>
      window.dataLayer = window.dataLayer || []
      function gtag() {
        dataLayer.push(arguments)
      }
      gtag("js", new Date())

      gtag("config", "UA-122581403-2")
    </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>欽ちゃんの仮装大賞パネル 再現ツール</title>
    <meta
      name="description"
      content="欽ちゃんの仮装大賞で使われていたパネルをweb上に再現してみました。操作方法は A S D キーで加点、R キーでリセットできます。※初回はリソース読み込みがうまくいかないことがあるので、一通り動かしてみたりページの再読込みをお試しください。"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css" />
    <style>
		html {
			touch-action: manipulation;
		}
      .is-center {
        text-align: center;
      }
      .is-vertical-center {
        display: flex;
        align-items: center;
      }
      .canvas-wrapper {
        position: relative;
        width: 160px;
        height: 720px;
        margin: auto;
      }
      .canvas-wrapper canvas {
        position: absolute;
        top: 0;
        left: 0;
      }
      .is-hide {
        display: none;
      }
    </style>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  </head>
  <body>
    <nav class="navbar is-warning" role="navigation" aria-label="main navigation">
      <div class="navbar-brand is-vertical-center">
        <h1 class="title is-4" style="margin: 0 12px 0 12px">欽ちゃんの仮装大賞パネルを再現してみた</h1>
        <button id="help" class="button is-primary"><i class="far fa-question-circle"></i></button>
      </div>
    </nav>

    <section class="section">
      <div class="container is-center">
        <div class="columns is-mobile">
          <div class="column" style="position: relative;">
            <div style="bottom: 0; position: absolute;"></div>
          </div>
          <div class="canvas-wrapper">
            <canvas id="content" width="160" height="720"></canvas>
            <canvas id="contentFrameAnim" width="160" height="720"></canvas>
          </div>
          <div class="column">
            <div id="helper-buttons" class="is-hide">
              <div style="margin-bottom: 30px;">
                <button id="reset" class="button">リセット</button>
              </div>
              <div>
                <button id="increment" class="button is-primary">加点</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="modal">
      <div class="modal-background"></div>
      <div class="modal-content">
        <div class="notification">
          操作方法
          <br />
          加点：A S D キー
          <br />
          リセット：R キー
          <br />
          <button id="show-helper-buttons" class="button is-primary">操作ボタンを表示・非表示</button>
          <br />
          <br />
          ※初回はリソース読み込みがうまくいかないことがあるので、一通り動かしてみたりページの再読込みをお試しください。
        </div>
      </div>
    </div>

    <audio src="se/clear.mp3" preload="auto"></audio>
    <audio src="se/fail.mp3" preload="auto"></audio>
    <audio src="se/1.mp3" preload="auto"></audio>
    <audio src="se/2.mp3" preload="auto"></audio>
    <audio src="se/3.mp3" preload="auto"></audio>
    <audio src="se/4.mp3" preload="auto"></audio>
    <audio src="se/5.mp3" preload="auto"></audio>
    <audio src="se/6.mp3" preload="auto"></audio>
    <audio src="se/7.mp3" preload="auto"></audio>
    <audio src="se/8.mp3" preload="auto"></audio>
    <audio src="se/9.mp3" preload="auto"></audio>
    <audio src="se/10.mp3" preload="auto"></audio>
    <audio src="se/11.mp3" preload="auto"></audio>
    <audio src="se/12.mp3" preload="auto"></audio>
    <audio src="se/13.mp3" preload="auto"></audio>
    <audio src="se/14.mp3" preload="auto"></audio>
    <audio src="se/15.mp3" preload="auto"></audio>
    <audio src="se/16.mp3" preload="auto"></audio>
    <audio src="se/17.mp3" preload="auto"></audio>
    <audio src="se/18.mp3" preload="auto"></audio>
    <audio src="se/19.mp3" preload="auto"></audio>
    <audio src="se/20.mp3" preload="auto"></audio>

    <script>
      "use strict"
      const WIDTH = 160
      const HEIGHT = 720

      class PanelManager {
        constructor(context, contextFrameAnim) {
          this.context = context
          this.imgInstance = new Image()
          this.count = 0
          this.frameAnim = {
            context: contextFrameAnim,
            instance: null,
            img: new Image(),
            step: 0,
            maxStep: 6,
          }
          this.failTimer = {
            instance: null,
            limit: 3000,
          }

          this.imgs = {
            bg: "img/base.png",
            numbers: [
              "img/1.png",
              "img/2.png",
              "img/3.png",
              "img/4.png",
              "img/5.png",
              "img/6.png",
              "img/7.png",
              "img/8.png",
              "img/9.png",
              "img/10.png",
              "img/11.png",
              "img/12.png",
              "img/13.png",
              "img/14.png",
              "img/15.png",
              "img/16.png",
              "img/17.png",
              "img/18.png",
              "img/19.png",
              "img/20.png",
            ],
            frameAnim: "img/kira_sprites.png",
          }
          this.se = {
            numbers: [
              new Audio("se/1.mp3"),
              new Audio("se/2.mp3"),
              new Audio("se/3.mp3"),
              new Audio("se/4.mp3"),
              new Audio("se/5.mp3"),
              new Audio("se/6.mp3"),
              new Audio("se/7.mp3"),
              new Audio("se/8.mp3"),
              new Audio("se/9.mp3"),
              new Audio("se/10.mp3"),
              new Audio("se/11.mp3"),
              new Audio("se/12.mp3"),
              new Audio("se/13.mp3"),
              new Audio("se/14.mp3"),
              new Audio("se/15.mp3"),
              new Audio("se/16.mp3"),
              new Audio("se/17.mp3"),
              new Audio("se/18.mp3"),
              new Audio("se/19.mp3"),
              new Audio("se/20.mp3"),
            ],
            clear: new Audio("se/clear.mp3"),
            fail: new Audio("se/fail.mp3"),
          }

          this.drawBg()
        }

        clearSE() {
          this.se.clear.pause()
          this.se.clear.currentTime = 0
          this.se.fail.pause()
          this.se.fail.currentTime = 0

          for (let i; i < this.se.numbers.length; i++) {
            this.se.numbers[i].pause()
            this.se.numbers[i].currentTime = 0
          }
          clearTimeout(this.failTimer.instance)
        }

        reset() {
          this.clearSE()
          this.clearAllCanvas()
          clearInterval(this.frameAnim.instance)
          this.count = 0
          this.frameAnim.step = 0

          this.drawBg()
        }

        getCount() {
          return this.count
        }

        increment() {
          if (this.count >= 20) {
            return
          }

          this.count++

          // サウンド再生
          this.se.numbers[this.count - 1].play()

          // 画像配置
          this.drawNowCount()

          // 15点以上で合格サウンド
          if (this.count == 15) {
            this.se.fail.pause()
            this.se.fail.currentTime = 0
            this.se.clear.play()
            this.playFrameAnim()
          }

          // 残念サウンド
          clearTimeout(this.failTimer.instance)
          if (this.count < 15) {
            this.failTimer.instance = setTimeout(() => {
              this.se.fail.play()
            }, this.failTimer.limit)
          }
        }

        draw(path) {
          return new Promise(resolve => {
            this.imgInstance.onload = () => resolve(this.imgInstance)
            this.imgInstance.src = path
          }).then(resImg => {
            this.context.drawImage(resImg, 0, 0, WIDTH, HEIGHT)
          })
        }

        drawBg() {
          this.draw(this.imgs.bg)
        }

        drawNowCount() {
          this.draw(this.imgs.numbers[this.count - 1])
        }

        drawCount(count) {
          this.draw(this.imgs.numbers[count - 1])
        }

        drawFrameAnim() {
          return new Promise(resolve => {
            this.frameAnim.img.onload = () => resolve(this.frameAnim.img)
            this.frameAnim.img.src = this.imgs.frameAnim
          }).then(resImg => {
            this.frameAnim.context.drawImage(resImg, WIDTH * this.frameAnim.step, 0, WIDTH, HEIGHT, 0, 0, WIDTH, HEIGHT)
          })
        }

        clearAllCanvas() {
          this.clearMainCanvas()
          this.clearFrameAnimCanvas()
        }

        clearMainCanvas() {
          this.context.clearRect(0, 0, WIDTH, HEIGHT)
        }

        clearFrameAnimCanvas() {
          this.frameAnim.context.clearRect(0, 0, WIDTH, HEIGHT)
        }

        playFrameAnim() {
          this.frameAnim.instance = setInterval(() => {
            this.clearFrameAnimCanvas()
            this.drawFrameAnim()

            if (this.frameAnim.step >= this.frameAnim.maxStep) {
              this.frameAnim.step = 1
            } else {
              this.frameAnim.step++
            }
          }, 50)
        }
      }

      window.onload = () => {
        const context = document.getElementById("content").getContext("2d")
        const contextFrameAnim = document.getElementById("contentFrameAnim").getContext("2d")
        const pm = new PanelManager(context, contextFrameAnim)

        document.addEventListener("keydown", e => {
          // key A, S, D
          const keys = [65, 83, 68]

          switch (e.keyCode) {
            case 65: // 'A' key
            case 83: // 'S' key
            case 68: // 'D' key
              pm.increment()
              break
            case 82: // 'R' key
              pm.reset()
              break
            default:
              break
          }
        })

        // modal
        document.getElementById("help").onclick = () => {
          document.getElementsByClassName("modal")[0].classList.add("is-active")
        }

        document.getElementsByClassName("modal-background")[0].onclick = () => {
          document.getElementsByClassName("modal")[0].classList.remove("is-active")
        }

        // show helper buttons
        document.getElementById("show-helper-buttons").onclick = () => {
          const hideClassName = "is-hide"
          const helperButtons = document.getElementById("helper-buttons")

          if (helperButtons.classList.contains(hideClassName)) {
            helperButtons.classList.remove(hideClassName)
          } else {
            helperButtons.classList.add(hideClassName)
          }
        }

        // helper buttons
        document.getElementById("increment").onclick = () => {
          pm.increment()
        }
        document.getElementById("reset").onclick = () => {
          pm.reset()
        }
      }
    </script>
  </body>
</html>
