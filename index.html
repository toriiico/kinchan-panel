<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>欽ちゃんの仮装大賞パネルツール</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css" />
    <style>
      .is-center {
        text-align: center;
      }
      .is-vertical-center {
        display: flex;
        align-items: center;
      }
    </style>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  </head>
  <body>
    <nav class="navbar is-warning" role="navigation" aria-label="main navigation">
      <div class="navbar-brand is-vertical-center">
        <h1 class="title is-4">欽ちゃんの仮装大賞パネルツール</h1>
      </div>
    </nav>

    <section class="section">
      <div class="container is-center">
        <canvas id="content" width="300" height="720"></canvas>
        <script>
          "use strict"
          const WIDTH = 160
          const HEIGHT = 720

          class PanelManager {
            constructor(context) {
              this.context = context
              this.imgInstance = new Image()
              this.count = 0
              this.frameAnim = {
                instance: null,
                step: 0,
                maxStep: 6,
              }
              this.frameAnimInstance = null
              this.frameAnimCount = 1
              this.frameAnimMax = 7
              this.failTimer = null

              this.imgs = {
                bg: "img/base.png",
                numbers: [
                  "img/1.png",
                  "img/2.png",
                  "img/3.png",
                  "img/4.png",
                  "img/5.png",
                  "img/6.png",
                  "img/7.png",
                  "img/8.png",
                  "img/9.png",
                  "img/10.png",
                  "img/11.png",
                  "img/12.png",
                  "img/13.png",
                  "img/14.png",
                  "img/15.png",
                  "img/16.png",
                  "img/17.png",
                  "img/18.png",
                  "img/19.png",
                  "img/20.png",
                ],
                // frameAnim: [
                //   "img/kira_1.png",
                //   "img/kira_2.png",
                //   "img/kira_3.png",
                //   "img/kira_4.png",
                //   "img/kira_5.png",
                //   "img/kira_6.png",
                //   "img/kira_7.png",
                // ],
                frameAnim: "img/kira_sprites.png",
              }
              this.se = {
                numbers: [
                  new Audio("se/1.mp3"),
                  new Audio("se/2.mp3"),
                  new Audio("se/3.mp3"),
                  new Audio("se/4.mp3"),
                  new Audio("se/5.mp3"),
                  new Audio("se/6.mp3"),
                  new Audio("se/7.mp3"),
                  new Audio("se/8.mp3"),
                  new Audio("se/9.mp3"),
                  new Audio("se/10.mp3"),
                  new Audio("se/11.mp3"),
                  new Audio("se/12.mp3"),
                  new Audio("se/13.mp3"),
                  new Audio("se/14.mp3"),
                  new Audio("se/15.mp3"),
                  new Audio("se/16.mp3"),
                  new Audio("se/17.mp3"),
                  new Audio("se/18.mp3"),
                  new Audio("se/19.mp3"),
                  new Audio("se/20.mp3"),
                ],
                clear: new Audio("se/clear.mp3"),
                fail: new Audio("se/fail.mp3"),
              }

              this.drawBg()
            }

            getCount() {
              return this.count
            }

            increment() {
              if (this.count >= 20) {
                return
              }

              this.count++
              // サウンド再生
              this.se.numbers[this.count - 1].play()

              // 画像配置
              this.drawNowCount()

              // 15点以上で合格サウンド
              if (this.count == 15) {
                this.se.clear.play()
                this.drawFrameAnim()
                this.playFrameAnim()
              }

              // 残念サウンド発生までのカウントを初期化
              // setTimeout
            }

            // draw(path) {
            //   this.imgInstance.onload = () => {
            //     this.context.drawImage(this.imgInstance, 0, 0, WIDTH, HEIGHT)
            //   }
            //   this.imgInstance.src = path
            // }

            draw(path) {
              return new Promise(resolve => {
                console.log("これは？")
                this.imgInstance.onload = () => resolve(this.imgInstance)
                this.imgInstance.src = path
              }).then(resImg => {
                console.log("こっち")
                this.context.drawImage(resImg, 0, 0, WIDTH, HEIGHT)
              })
            }

            drawBg() {
              this.draw(this.imgs.bg)
            }

            drawNowCount() {
              this.draw(this.imgs.numbers[this.count - 1])
            }

            drawCount(count) {
              this.draw(this.imgs.numbers[count - 1])
            }

            drawFrameAnim() {
              return new Promise(resolve => {
                // new Image() は counterのimageと描画タイミングが被って描画されないバグ対策
                const frameImg = new Image()
                frameImg.onload = () => resolve(frameImg)
                frameImg.src = this.imgs.frameAnim
              }).then(resImg => {
                this.context.drawImage(
                  resImg,
                  WIDTH * this.frameAnim.step,
                  0,
                  WIDTH * (this.frameAnim.step + 1),
                  HEIGHT,
                  0,
                  0,
                  WIDTH,
                  HEIGHT
                )
              })
            }

            playFrameAnim() {
              this.frameAnim.instance = setInterval(() => {
                console.log("toottayo")
                console.log(this.frameAnim.step)
                console.log(WIDTH * this.frameAnim.step)
                if (this.frameAnim.step >= this.frameAnim.maxStep) {
                  this.frameAnim.step = 1
                } else {
                  this.frameAnim.step++
                }
              }, 1000)
            }
          }

          window.onload = () => {
            const context = document.getElementById("content").getContext("2d")
            const pm = new PanelManager(context)

            // const loadImage = url => {
            //   return new Promise(resolve => {
            //     const img = new Image()
            //     img.onload = () => resolve(img)
            //     img.src = url
            //   })
            // }

            // Promise.all(imgs.map(loadImage)).then(imgs => {
            //   imgs.forEach(img => {
            //     context.drawImage(img, 0, 0, 160, 720)
            //   })
            // })

            document.addEventListener("keydown", e => {
              // Allow only specific keys
              pm.increment()
            })
          }
        </script>
      </div>
    </section>

    <audio src="se/clear.mp3" preload="auto"></audio>
    <audio src="se/fail.mp3" preload="auto"></audio>
    <audio src="se/1.mp3" preload="auto"></audio>
    <audio src="se/2.mp3" preload="auto"></audio>
    <audio src="se/3.mp3" preload="auto"></audio>
    <audio src="se/4.mp3" preload="auto"></audio>
    <audio src="se/5.mp3" preload="auto"></audio>
    <audio src="se/6.mp3" preload="auto"></audio>
    <audio src="se/7.mp3" preload="auto"></audio>
    <audio src="se/8.mp3" preload="auto"></audio>
    <audio src="se/9.mp3" preload="auto"></audio>
    <audio src="se/10.mp3" preload="auto"></audio>
    <audio src="se/11.mp3" preload="auto"></audio>
    <audio src="se/12.mp3" preload="auto"></audio>
    <audio src="se/13.mp3" preload="auto"></audio>
    <audio src="se/14.mp3" preload="auto"></audio>
    <audio src="se/15.mp3" preload="auto"></audio>
    <audio src="se/16.mp3" preload="auto"></audio>
    <audio src="se/17.mp3" preload="auto"></audio>
    <audio src="se/18.mp3" preload="auto"></audio>
    <audio src="se/19.mp3" preload="auto"></audio>
    <audio src="se/20.mp3" preload="auto"></audio>
  </body>
</html>
